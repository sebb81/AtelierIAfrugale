<section class="grid">
  <section class="stage-card">
    <div class="stage-header">
      <div>
        <h2 id="stage-title">Atelier vision locale</h2>
        <p id="stage-desc">Détection de gestes en local. L’objectif n’est pas la perfection, mais un seuil suffisant.</p>
      </div>
      <div id="status" class="status">Initialisation...</div>
    </div>
    <div id="stage-media" class="stage-media">
      <div class="stack">
        <video id="video" autoplay playsinline></video>
        <canvas id="overlay"></canvas>
      </div>
    </div>
    <div id="gesture-readout" class="gesture-readout" hidden>
      <div class="gesture-time">
        Inference time (ms): <strong id="inference-time">0.0</strong>
      </div>
      <div class="gesture-bar">
        <div class="gesture-bar-labels">
          <span id="gesture-bar-name">Aucune main</span>
          <span id="gesture-bar-score">0%</span>
        </div>
        <div class="gesture-bar-track">
          <span id="gesture-bar-fill"></span>
        </div>
      </div>
    </div>
    <div id="audio-panel" class="audio-panel" hidden>
      <div class="audio-controls">
        <div class="audio-row">
          <label for="audio-language">Langue</label>
          <select id="audio-language">
            <option value="fr">Francais</option>
            <option value="en">Anglais</option>
            <option value="es">Espagnol</option>
            <option value="de">Allemand</option>
            <option value="it">Italien</option>
          </select>
        </div>
        <div class="audio-row audio-actions">
          <button id="audio-record" class="primary" type="button">Enregistrer</button>
          <button id="audio-stop" class="ghost" type="button" disabled>Stop</button>
          <button id="audio-clear" class="ghost" type="button">Effacer les essais</button>
        </div>
        <p id="audio-status" class="audio-status" hidden></p>
      </div>
      <audio id="audio-playback" class="audio-playback" controls hidden></audio>
      <div id="audio-attempts" class="audio-attempts"></div>
      <div id="audio-feedback" class="audio-feedback" hidden>
        <div class="audio-feedback-title">Feedback</div>
        <div id="audio-feedback-body" class="audio-feedback-body"></div>
      </div>
    </div>
    <div id="chat-panel" class="chat-panel" hidden>
      <div class="chat-controls">
        <div class="chat-prompt">
          <label for="chat-system">Prompt systeme</label>
          <textarea id="chat-system" rows="3"></textarea>
        </div>
        <div class="chat-buttons">
          <button id="chat-reset" class="ghost" type="button">Reinitialiser</button>
          <button id="chat-clear" class="ghost" type="button">Effacer</button>
        </div>
      </div>
      <div id="rag-controls" class="rag-controls" hidden>
        <div class="rag-grid">
          <div class="rag-field">
            <label for="rag-files">Documents (PDF, TXT, MD)</label>
            <input id="rag-files" type="file" multiple accept=".pdf,.txt,.md" />
          </div>
          <div class="rag-buttons">
            <button id="rag-index" class="primary" type="button">Indexer</button>
            <button id="rag-reset" class="ghost" type="button">Reinitialiser base</button>
          </div>
          <div class="rag-field">
            <label for="rag-chunk-size">Taille des chunks</label>
            <input id="rag-chunk-size" type="number" min="400" max="4000" step="100" value="1200" />
          </div>
          <div class="rag-field">
            <label for="rag-overlap">Chevauchement</label>
            <input id="rag-overlap" type="number" min="0" max="1000" step="50" value="200" />
          </div>
          <div class="rag-field">
            <label for="rag-top-k">Top-K passages</label>
            <input id="rag-top-k" type="number" min="1" max="20" step="1" value="6" />
          </div>
          <div class="rag-field">
            <label for="rag-min-score">Score minimum</label>
            <div class="rag-range">
              <input id="rag-min-score" type="range" min="0" max="1" step="0.01" value="0.25" />
              <span id="rag-min-score-value">0.25</span>
            </div>
          </div>
        </div>
        <div id="rag-counts" class="rag-counts">Chunks : 0 · Sources : 0</div>
      </div>
      <div id="chat-log" class="chat-log"></div>
      <form id="chat-form" class="chat-form">
        <textarea id="chat-input" rows="2" placeholder="Posez votre question..."></textarea>
        <button id="chat-send" class="primary" type="submit">Envoyer</button>
      </form>
      <div id="rag-sources" class="rag-sources" hidden>
        <div class="rag-sources-header">Passages utilises</div>
        <div id="rag-source-list" class="rag-source-list"></div>
      </div>
      <p id="chat-status" class="chat-status" hidden></p>
    </div>
    <div id="stage-placeholder" class="stage-placeholder" hidden>
      <h3>Module en preparation</h3>
      <p>Cette mission utilise un autre capteur ou un autre type de modele.</p>
    </div>
  </section>

  <aside class="mission-card">
    <div class="mission-header">
      <div>
        <h2 id="mission-title">Briefing de mission</h2>
        <p id="mission-subtitle">Serious game IA frugale : missions courtes, badges a debloquer.</p>
      </div>
      <div class="progress-meta">
        <span id="step-counter">Etape 1 / 1</span>
      </div>
    </div>
    <div class="progress-bar">
      <span id="progress-bar" class="progress-fill"></span>
    </div>
    <div class="mission-body">
      <h3 id="step-title"></h3>
      <p id="step-body"></p>
      <p id="step-hint" class="hint"></p>
    </div>
    <div class="mission-challenge" id="challenge-panel">
      <div class="slider-row">
        <label id="threshold-label" for="threshold">Seuil de confiance</label>
        <input id="threshold" type="range" min="0" max="1" step="0.01" value="0.6" />
        <span id="threshold-value">0.60</span>
      </div>
      <div class="stat-grid">
        <div class="stat">
          <span id="stat-label-score">Score geste</span>
          <strong id="gesture-score">0.00</strong>
        </div>
        <div class="stat">
          <span id="stat-label-status">Reconnaissance</span>
          <strong id="gesture-status">En attente</strong>
        </div>
        <div class="stat">
          <span id="stat-label-best">Meilleur seuil</span>
          <strong id="best-threshold">0.00</strong>
        </div>
        <div class="stat">
          <span id="stat-label-badge">Badge</span>
          <strong id="badge-state">Verrouille</strong>
        </div>
      </div>
      <div id="confidence-acceptance-panel" class="confidence-acceptance" hidden>
        <label id="confidence-acceptance-row" class="confidence-checkbox-row" hidden>
          <input id="confidence-acceptance-checkbox" type="checkbox" />
          <span>Nous acceptons ce niveau de confiance pour ce besoin</span>
        </label>
        <div id="confidence-acceptance-summary" class="confidence-summary" hidden>
          <div class="confidence-summary-title">Décision enregistrée</div>
          <p>Seuil choisi : <strong id="accepted-threshold">0.00</strong></p>
          <p>Confiance observée : <strong id="accepted-confidence">~0.00</strong></p>
          <p>"Un autre contexte aurait pu conduire à un autre choix."</p>
        </div>
      </div>
    </div>
    <div id="gesture-controls" class="gesture-controls" hidden>
      <h3>Parametres MediaPipe</h3>
      <div class="control-grid">
        <!-- <div class="control-row select-row">
          <label for="delegate-select">Inference delegate</label>
          <select id="delegate-select">
            <option value="cpu">CPU inference</option>
            <option value="gpu">GPU inference</option>
          </select>
        </div>
        <div class="control-row select-row">
          <label for="model-select">Model selections</label>
          <select id="model-select">
            <option value="gesture_recognizer">MP Hand Gesture Classifier</option>
          </select>
        </div> -->
        <div class="control-row range-row">
          <label for="num-hands">Demo num hands</label>
          <input id="num-hands" type="range" min="1" max="2" step="1" value="1" />
          <span id="num-hands-value">1</span>
        </div>
        <div class="control-row range-row">
          <label for="min-detection">Minimum hand detection confidence</label>
          <input id="min-detection" type="range" min="0" max="1" step="0.01" value="0.5" />
          <span id="min-detection-value">50%</span>
        </div>
        <div class="control-row range-row">
          <label for="min-presence">Minimum hand presence confidence</label>
          <input id="min-presence" type="range" min="0" max="1" step="0.01" value="0.5" />
          <span id="min-presence-value">50%</span>
        </div>
        <div class="control-row range-row">
          <label for="min-tracking">Minimum tracking confidence</label>
          <input id="min-tracking" type="range" min="0" max="1" step="0.01" value="0.5" />
          <span id="min-tracking-value">50%</span>
        </div>
      </div>
      <p id="config-warning" class="control-warning" hidden></p>
    </div>
  </aside>
</section>
